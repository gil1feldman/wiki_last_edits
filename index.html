<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>עריכות אחרונות בוויקיפדיה</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      margin: 20px;
    }

    h1 {
      margin-bottom: 10px;
    }

    .control-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .control-bar input {
      flex: 1;
      min-width: 200px;
      padding: 6px;
      font-size: 15px;
    }

    #refresh-btn {
      padding: 6px 12px;
      font-size: 15px;
      cursor: pointer;
    }

    #summary-info {
      font-size: 1.1em;
      color: #555;
      margin-bottom: 20px;
    }

    .summaries {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .summary-box {
      flex: 1;
      min-width: 300px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
    }

    th {
      background-color: #f2f2f2;
    }

    a {
      color: #0645ad;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <h1>עריכות אחרונות בוויקיפדיה</h1>

  <!-- שורת שליטה -->
  <div class="control-bar">
    <input type="text" id="pageFilter" onkeyup="filterTable()" placeholder="🔎 סינון לפי שם הערך">
    <button id="refresh-btn" onclick="init()">🔄 רענון</button>
    <input type="text" id="editorFilter" onkeyup="filterTable()" placeholder="🔎 סינון לפי שם העורך">
  </div>

  <!-- מידע על כמות וטווח -->
  <div id="summary-info"></div>

  <!-- טבלאות סיכום -->
  <div class="summaries">
    <!-- טבלת ערכים -->
    <div class="summary-box">
      <h2>10 הערכים עם הכי הרבה עריכות</h2>
      <table id="summaryTable">
        <thead>
          <tr>
            <th>שם הערך</th>
            <th>מספר</th>
            <th>זמן אחרון</th>
            <th>קישור</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- טבלת עורכים -->
    <div class="summary-box">
      <h2>10 העורכים הפעילים ביותר</h2>
      <table id="editorsTable">
        <thead>
          <tr>
            <th>שם העורך</th>
            <th>מספר עריכות</th>
            <th>קישור</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- טבלת עריכות -->
  <table id="editsTable">
    <thead>
      <tr>
        <th>שם הערך</th>
        <th>זמן העריכה</th>
        <th>הערות</th>
        <th>גודל השינוי</th>
        <th>קישור להבדל</th>
        <th>קישור לערך</th>
        <th>שם העורך</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allEdits = [];

    async function fetchRecentChanges() {
      const url = 'https://he.wikipedia.org/w/api.php?action=query&format=json&list=recentchanges&rcnamespace=0&rclimit=500&rcprop=title|ids|sizes|user|comment|timestamp&origin=*';
      const response = await fetch(url);
      const data = await response.json();
      return data.query.recentchanges;
    }

    function populateEditsTable(edits) {
      const tableBody = document.querySelector('#editsTable tbody');
      tableBody.innerHTML = '';

      edits.forEach(edit => {
        const row = document.createElement('tr');
        const sizeChange = (edit.newlen ?? 0) - (edit.oldlen ?? 0);
        row.innerHTML = `
          <td>${edit.title}</td>
          <td>${new Date(edit.timestamp).toLocaleString('he-IL')}</td>
          <td>${edit.comment || ''}</td>
          <td>${sizeChange > 0 ? '+' : ''}${sizeChange}</td>
          <td><a href="https://he.wikipedia.org/w/index.php?diff=${edit.revid}" target="_blank">הבדל</a></td>
          <td><a href="https://he.wikipedia.org/wiki/${encodeURIComponent(edit.title)}" target="_blank">צפייה</a></td>
          <td><a href="https://he.wikipedia.org/wiki/User:${encodeURIComponent(edit.user)}" target="_blank">${edit.user}</a></td>
        `;
        tableBody.appendChild(row);
      });

      updateSummaryTables(edits);
      updateSummaryInfo(edits);
    }

    function updateSummaryInfo(edits) {
      const count = edits.length;
      if (count === 0) return;

      const times = edits.map(e => new Date(e.timestamp));
      const minTime = new Date(Math.min(...times));
      const maxTime = new Date(Math.max(...times));

      const formatter = new Intl.DateTimeFormat('he-IL', {
        dateStyle: 'medium',
        timeStyle: 'short',
      });

      const range = `${formatter.format(minTime)} – ${formatter.format(maxTime)}`;
      const summaryText = `${count} עריכות אחרונות | ${range}`;
      document.getElementById('summary-info').textContent = summaryText;
    }

    function filterTable() {
      const editorInput = document.getElementById('editorFilter').value.toLowerCase();
      const pageInput = document.getElementById('pageFilter').value.toLowerCase();
      const rows = document.querySelectorAll('#editsTable tbody tr');

      rows.forEach(row => {
        const editor = row.cells[6].textContent.toLowerCase();
        const page = row.cells[0].textContent.toLowerCase();

        if (editor.includes(editorInput) && page.includes(pageInput)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });

      const filtered = allEdits.filter(edit =>
        edit.user.toLowerCase().includes(editorInput) &&
        edit.title.toLowerCase().includes(pageInput)
      );

      updateSummaryTables(filtered);
      updateSummaryInfo(filtered);
    }

    function updateSummaryTables(edits) {
      const pages = {};
      edits.forEach(edit => {
        const title = edit.title;
        const time = edit.timestamp;
        if (!pages[title]) pages[title] = { count: 0, latest: time };
        pages[title].count++;
        if (new Date(time) > new Date(pages[title].latest)) {
          pages[title].latest = time;
        }
      });

      const topPages = Object.entries(pages)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);

      const summaryBody = document.querySelector('#summaryTable tbody');
      summaryBody.innerHTML = '';
      topPages.forEach(([title, data]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${title}</td>
          <td>${data.count}</td>
          <td>${new Date(data.latest).toLocaleString('he-IL')}</td>
          <td><a href="https://he.wikipedia.org/wiki/${encodeURIComponent(title)}" target="_blank">צפייה</a></td>
        `;
        summaryBody.appendChild(row);
      });

      const editors = {};
      edits.forEach(edit => {
        const user = edit.user;
        if (!editors[user]) editors[user] = 0;
        editors[user]++;
      });

      const topEditors = Object.entries(editors)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const editorsBody = document.querySelector('#editorsTable tbody');
      editorsBody.innerHTML = '';
      topEditors.forEach(([user, count]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user}</td>
          <td>${count}</td>
          <td><a href="https://he.wikipedia.org/wiki/User:${encodeURIComponent(user)}" target="_blank">פרופיל</a></td>
        `;
        editorsBody.appendChild(row);
      });
    }

    async function init() {
      allEdits = await fetchRecentChanges();
      populateEditsTable(allEdits);
    }

    init();
  </script>

</body>
</html>
